<!DOCTYPE html>
<html>
<head>
    <title>Contract {{ hash }}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-wasm.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .meta-container { display: flex; gap: 20px; margin: 20px 0; }
        .meta { background: #f5f5f5; padding: 20px; flex: 1; }
        .meta table { width: 100%; border-collapse: collapse; }
        .meta td { border: 1px solid #ddd; padding: 8px; }
        .meta td:first-child { font-weight: bold; background-color: #f0f0f0; }
        .imports { background: #f0f8ff; padding: 20px; flex: 1; }
        .imports ul { margin: 0; padding-left: 20px; }
        .imports li { font-family: monospace; margin: 2px 0; }
        .instances { background: #f8f8f8; padding: 20px; flex: 1; }
        .instances ul { margin: 0; padding-left: 0; list-style: none; }
        .instances li { margin: 2px 0; }
        .instance-address { display: inline-block; background: #e6fffa; color: #234e52; padding: 2px 8px; margin: 2px; border-radius: 3px; font-size: 12px; font-family: monospace; cursor: pointer; transition: background-color 0.2s; }
        .instance-address:hover { background: #b2f5ea; }
        .spec { background: #f8f8f8; padding: 20px; margin: 20px 0; font-size: 12px; }
        .function { margin-bottom: 30px; }
        .function h3 { font-family: monospace; background: #2d3748; color: #e2e8f0; padding: 10px; border-radius: 5px; margin: 0 0 10px 0; }
        .function p { margin: 0; }
        pre { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .wat pre { background: #f8f8f8; color: #333; margin: 0; font-size: 12px; }
        .wat code { background: none; color: inherit; }
        h1 { color: #2d3748; }
        .contract-hash { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        h2 { color: #4a5568; }
        .page-actions { margin: 15px 0; }
        .wat-toggle { cursor: pointer; user-select: none; }
        .wat-content { display: none; }
        .page-actions a { margin-right: 15px; text-decoration: none; color: #3182ce; }
        .page-actions a:hover { text-decoration: underline; }
        .download-link { background: #e6fffa; color: #234e52; padding: 8px 12px; border-radius: 5px; font-weight: bold; }
        .download-link:hover { background: #b2f5ea; text-decoration: none; }
    </style>
</head>
<body>
    <h1 class="contract-hash">Contract {{ hash }}</h1>
    <div class="page-actions">
        <a href="index.html">‚Üê Back to Index</a>
        <a href="https://github.com/leighmcculloch/stellar-contract-wasms/raw/refs/heads/main/contracts/{{ hash }}.wasm" class="download-link">üì• Download WASM</a>
    </div>

    {% if meta or instances %}
    <div class="meta-container">
        {% if meta %}
        <div>
            <h2>Meta</h2>
            <div class="meta">
                <table>
                    {% for key, value in meta %}
                    <tr>
                        <td>{{ key }}</td>
                        <td>{{ value }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
        {% endif %}
        {% if instances %}
        <div>
            <h2>Instances</h2>
            <div class="instances">
                <ul>
                    {% for instance in instances %}
                    <li><span class="instance-address" onclick="searchForInstance('{{ instance }}')">{{ instance }}</span></li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if spec %}
    <h2>Interface</h2>
    <div class="spec">
        {% for function in spec.functions %}
        <div class="function">
            {% if function.doc %}
            <div style="white-space: pre-wrap">{{ function.doc | safe }}</div>
            {% endif %}
            <pre><code class="language-rust">{{ function.code | safe }}</code></pre>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if imports %}
    <h2>Imports</h2>
    <div class="imports">
        <ul>
            {% for import in imports %}
            <li>{{ import }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if wat %}
    <h2 class="wat-toggle" onclick="toggleWat()">WebAssembly Text (WAT) ‚ñ∂</h2>
    <div class="wat wat-content">
        <div id="wat-loading" style="display: none;">Loading WAT...</div>
        <div id="wat-error" style="display: none; color: #e53e3e;">Failed to load WAT file.</div>
        <pre id="wat-code"><code class="language-wasm"></code></pre>
    </div>
    {% endif %}

    <script>
        function searchForInstance(instanceAddress) {
            // Redirect to index page with the instance address as search query
            window.location.href = 'index.html?search=' + encodeURIComponent(instanceAddress);
        }

        let watLoaded = false;

        async function toggleWat() {
            const content = document.querySelector('.wat-content');
            const toggle = document.querySelector('.wat-toggle');
            const loading = document.getElementById('wat-loading');
            const error = document.getElementById('wat-error');
            const code = document.getElementById('wat-code');

            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                toggle.textContent = 'WebAssembly Text (WAT) ‚ñº';

                if (!watLoaded) {
                    loading.style.display = 'block';
                    error.style.display = 'none';

                    try {
                        const response = await fetch(`https://api.github.com/repos/leighmcculloch/stellar-contract-wasms/contents/wat/{{ hash }}.wat`);
                        if (response.ok) {
                            const data = await response.json();
                            const watText = atob(data.content);
                            code.innerHTML = `<code class="language-wasm">${escapeHtml(watText)}</code>`;
                            // Re-initialize Prism highlighting for the new content
                            if (window.Prism) {
                                Prism.highlightElement(code.querySelector('code'));
                            }
                        } else {
                            throw new Error('Failed to fetch');
                        }
                    } catch (err) {
                        error.style.display = 'block';
                        code.innerHTML = '';
                    } finally {
                        loading.style.display = 'none';
                        watLoaded = true;
                    }
                }
            } else {
                content.style.display = 'none';
                toggle.textContent = 'WebAssembly Text (WAT) ‚ñ∂';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
