name: Fetch Contracts

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  list-buckets:
    runs-on: ubuntu-latest
    outputs:
      bucket0: ${{ steps.list-buckets.outputs.bucket0 }}
      bucket1: ${{ steps.list-buckets.outputs.bucket1 }}
      bucket2: ${{ steps.list-buckets.outputs.bucket2 }}
      bucket3: ${{ steps.list-buckets.outputs.bucket3 }}
      bucket4: ${{ steps.list-buckets.outputs.bucket4 }}
      bucket5: ${{ steps.list-buckets.outputs.bucket5 }}
      bucket6: ${{ steps.list-buckets.outputs.bucket6 }}
      bucket7: ${{ steps.list-buckets.outputs.bucket7 }}
      bucket8: ${{ steps.list-buckets.outputs.bucket8 }}
      bucket9: ${{ steps.list-buckets.outputs.bucket9 }}
      bucket10: ${{ steps.list-buckets.outputs.bucket10 }}
      bucket11: ${{ steps.list-buckets.outputs.bucket11 }}
      bucket12: ${{ steps.list-buckets.outputs.bucket12 }}
      bucket13: ${{ steps.list-buckets.outputs.bucket13 }}
      bucket14: ${{ steps.list-buckets.outputs.bucket14 }}
      bucket15: ${{ steps.list-buckets.outputs.bucket15 }}
      bucket16: ${{ steps.list-buckets.outputs.bucket16 }}
      bucket17: ${{ steps.list-buckets.outputs.bucket17 }}
      bucket18: ${{ steps.list-buckets.outputs.bucket18 }}
      bucket19: ${{ steps.list-buckets.outputs.bucket19 }}
      bucket20: ${{ steps.list-buckets.outputs.bucket20 }}
      bucket21: ${{ steps.list-buckets.outputs.bucket21 }}
    steps:
      - uses: actions/checkout@v4
      - run: rustup upgrade
      - name: list-buckets
        id: list-buckets
        run: |
          BUCKETS=$(cd list-buckets && cargo run --locked --path .)
          echo "Buckets: $BUCKETS"
          IFS=' ' read -r -a bucket_array <<< "$BUCKETS"
          for i in {0..21}; do
            if [ $i -lt ${#bucket_array[@]} ]; then
              echo "bucket$i=${bucket_array[$i]}" >> $GITHUB_OUTPUT
            else
              echo "bucket$i=" >> $GITHUB_OUTPUT
            fi
          done

  get-contracts:
    runs-on: ubuntu-latest
    needs: list-buckets
    steps:
      - uses: actions/checkout@v4
      - run: rustup upgrade
      - name: Restore cached buckets
        uses: actions/cache@v4
        with:
          path: cache/
          key: buckets-${{ github.sha }}
          restore-keys: |
            buckets-

      - name: Download buckets from list
        run: |
          mkdir -p cache/
          BUCKETS="${{ needs.list-buckets.outputs.bucket0 }} ${{ needs.list-buckets.outputs.bucket1 }} ${{ needs.list-buckets.outputs.bucket2 }} ${{ needs.list-buckets.outputs.bucket3 }} ${{ needs.list-buckets.outputs.bucket4 }} ${{ needs.list-buckets.outputs.bucket5 }} ${{ needs.list-buckets.outputs.bucket6 }} ${{ needs.list-buckets.outputs.bucket7 }} ${{ needs.list-buckets.outputs.bucket8 }} ${{ needs.list-buckets.outputs.bucket9 }} ${{ needs.list-buckets.outputs.bucket10 }} ${{ needs.list-buckets.outputs.bucket11 }} ${{ needs.list-buckets.outputs.bucket12 }} ${{ needs.list-buckets.outputs.bucket13 }} ${{ needs.list-buckets.outputs.bucket14 }} ${{ needs.list-buckets.outputs.bucket15 }} ${{ needs.list-buckets.outputs.bucket16 }} ${{ needs.list-buckets.outputs.bucket17 }} ${{ needs.list-buckets.outputs.bucket18 }} ${{ needs.list-buckets.outputs.bucket19 }} ${{ needs.list-buckets.outputs.bucket20 }} ${{ needs.list-buckets.outputs.bucket21 }}"
          echo "Processing buckets: $BUCKETS"
          # Assuming the list is space-separated bucket IDs
          for bucket in $BUCKETS; do
            if [ -n "$bucket" ] && [ ! -f "cache/bucket-${bucket}.xdr.gz" ]; then
              echo "Bucket $bucket not cached locally, would need to fetch it"
              # Here you might need to add logic to download the bucket if not cached
            elif [ -n "$bucket" ]; then
              echo "Bucket $bucket already cached"
            fi
          done

      - name: Build get-contracts-from-buckets
        run: cargo build --release --bin get-contracts-from-buckets

      - name: Run get-contracts-from-buckets
        run: |
          BUCKETS="${{ needs.list-buckets.outputs.bucket0 }} ${{ needs.list-buckets.outputs.bucket1 }} ${{ needs.list-buckets.outputs.bucket2 }} ${{ needs.list-buckets.outputs.bucket3 }} ${{ needs.list-buckets.outputs.bucket4 }} ${{ needs.list-buckets.outputs.bucket5 }} ${{ needs.list-buckets.outputs.bucket6 }} ${{ needs.list-buckets.outputs.bucket7 }} ${{ needs.list-buckets.outputs.bucket8 }} ${{ needs.list-buckets.outputs.bucket9 }} ${{ needs.list-buckets.outputs.bucket10 }} ${{ needs.list-buckets.outputs.bucket11 }} ${{ needs.list-buckets.outputs.bucket12 }} ${{ needs.list-buckets.outputs.bucket13 }} ${{ needs.list-buckets.outputs.bucket14 }} ${{ needs.list-buckets.outputs.bucket15 }} ${{ needs.list-buckets.outputs.bucket16 }} ${{ needs.list-buckets.outputs.bucket17 }} ${{ needs.list-buckets.outputs.bucket18 }} ${{ needs.list-buckets.outputs.bucket19 }} ${{ needs.list-buckets.outputs.bucket20 }} ${{ needs.list-buckets.outputs.bucket21 }}"
          ./target/release/get-contracts-from-buckets $BUCKETS

      - name: Check for new contracts
        id: check-changes
        run: |
          if [ -d contracts/ ] && [ "$(ls -A contracts/)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push contracts
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add contracts/
          git commit -m "Update contracts from buckets" || echo "No changes to commit"
          git push
